# Code to clean up Rwanda CHAIN IP data -----------------------------------
# Laura Hughes, April 2016, lhughes@usaid.gov


# Installing packages note ------------------------------------------------
# In Mac OS X, need to install GDAL first.
# In terminal, install macports: https://www.macports.org/install.php
# Then 'sudo port install gdal'
# Go back to R and install rgdal
# install.packages("rgdal",  type="source")

library(llamar)
library(splitstackshape) 
library(rgdal)
library(maptools)
loadPkgs()


# Import and clean “raw” data -----------------------------------------------------

# geo data ----------------------------------------------------------------

# Raw shapefile in R
rwShp <- readShapePoly('~/Documents/USAID/Rwanda/data in/Rwanda_Admin3/Rwanda_Admin_Three.shp')

rwAdm = rwShp@data

# Pull out all the Adm2 names for each Adm1
findAdm2 = function(adm1Name){
  districts = rwAdm %>% 
    filter(Province %like% adm1Name) %>% 
    select(District)
  
  districts = unique(as.character(districts$District)) # Eliminate duplicates; converts from a factor to a character
  
  districts = paste0(districts, collapse = ', ') # Convert to a string
}

northDistricts = findAdm2('North')
southDistricts = findAdm2('South')
eastDistricts = findAdm2('East')
westDistricts = findAdm2('West')
kigaliDistricts = findAdm2('Kigali')
allDistricts = paste(northDistricts, southDistricts, eastDistricts, westDistricts, sep = ', ')


# Project locations -------------------------------------------------------
df = read_excel('~/Documents/USAID/Rwanda/CHAIN/datain/Locations of CHAIN IMs in Rwanda (2016-03-22).xlsm')

# Cleanup #1: rename columns
# Fix any values that are "all" region/country
df2 = df %>% 
  select(-`To include by Geo Center?`) %>% # Drop unneeded columns
  rename(project = Project,
         mechanism = `Implementing Mechanism`,
         IP = `Implementing Partner`,
         manager = `AOR/COR or Activity Manager`,
         nationwide = `Nationwide?\r\n(If yes, skip the remaining columns)`) %>% # rename so easier to deal with
  mutate(nationwide = ifelse(nationwide %in% c('Yes', 'yes', 'Y', 'y'), # If all of the province or country are selected, convert to a list of the Adm2 names.
                             allDistricts, NA),
         `Kigali Province` = ifelse(`Kigali Province` %like% 'All', 
                                    kigaliDistricts, `Kigali Province`),
         `Northern Province` = ifelse(`Northern Province` %like% 'All', 
                                    northDistricts, `Northern Province`),
         `Southern Province ` = ifelse(`Southern Province ` %like% 'All', 
                                    southDistricts, `Southern Province `),
         `Eastern Province` = ifelse(`Eastern Province` %like% 'All', 
                                    eastDistricts, `Eastern Province`),
         `Western Province` = ifelse(`Western Province` %like% 'All', 
                                    westDistricts, `Western Province`))

# Split Nationwide
df2 = cSplit(df2, 'nationwide', ',')


# Split Kigali
df2 = cSplit(df2, 'Kigali Province', ',')

# Split Northern
df2 = cSplit(df2, 'Northern Province', ',')

# Split Western
df2 = cSplit(df2, 'Western Province', ',')

# Split Southern
df2 = cSplit(df2, 'Southern Province ', ',')

# Split Eastern
df2 = cSplit(df2, 'Eastern Province', ',')

# Convert to a tidy data frame
df2 = df2 %>% 
gather(regCol, district, -project, -mechanism, -IP, -manager) %>% # convert from wide to long df
  select(-regCol) %>% # Remove column generated by gathering
  filter(!is.na(district), district != 'N/A') # remove NAs



# Results -----------------------------------------------------------------

results = read_excel('~/Documents/USAID/Rwanda/CHAIN/datain/RF Map to Partners.xlsx')


# Split the column based on the comma
results = cSplit(results, 'Partners', ',') %>% 
  gather(partnerNum, partner, -Level, -Result, -INWA) %>% # Convert from wide to long dataset
  select(-partnerNum) %>%  # Remove artifact of split/gather
  filter(!is.na(partner)) %>% # Remove blank lines
  mutate(INWA = ifelse(INWA %like% 'No INWA', 0, 1)) # Convert to binary

# Check INWA tag is correct.




# Merge df w/ Adm names ---------------------------------------------------
df2 = left_join(df2, rwAdm, by = c("district" = "District"))


rw = readOGR(dsn=".", layer="Rwanda_Admin_Three")
rw@data$id = rownames(rw@data)
rw.points = fortify(rw, region="id")
rw.df = plyr::join(rw.points, rw@data, by="id")

rw@data$id = rownames(rw@data)

ggplot(rw) + 
  aes(long,lat)+
  geom_polygon() +
  geom_path(color="white") +
  coord_equal() +
  scale_fill_brewer("Utah Ecoregion")